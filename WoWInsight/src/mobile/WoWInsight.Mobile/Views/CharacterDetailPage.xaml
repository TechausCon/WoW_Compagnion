<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:WoWInsight.Mobile.ViewModels"
             xmlns:dto="clr-namespace:WoWInsight.Mobile.DTOs"
             x:Class="WoWInsight.Mobile.Views.CharacterDetailPage"
             Title="{Binding Character.Name}"
             BackgroundColor="{StaticResource WoWDarkBackground}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Style TargetType="Label" x:Key="StatLabel">
                <Setter Property="TextColor" Value="{StaticResource WoWTextLight}" />
                <Setter Property="FontSize" Value="14" />
            </Style>
            <Style TargetType="Label" x:Key="StatValue">
                <Setter Property="TextColor" Value="{StaticResource WoWGold}" />
                <Setter Property="FontSize" Value="14" />
                <Setter Property="FontAttributes" Value="Bold" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <RefreshView IsRefreshing="{Binding IsRefreshing}" Command="{Binding RefreshCommand}" RefreshColor="{StaticResource WoWGold}">
        <ScrollView>
            <VerticalStackLayout Spacing="20" Padding="15">

                <!-- Character Header Card -->
                <Border Stroke="{StaticResource WoWGoldDim}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 8"
                        BackgroundColor="{StaticResource WoWPanelBackground}"
                        Padding="15">
                    <Grid RowDefinitions="Auto, Auto" ColumnDefinitions="Auto, *">
                        <Image Grid.RowSpan="2" Source="icon_char.svg" WidthRequest="60" HeightRequest="60" VerticalOptions="Center" Margin="0,0,15,0"/>

                        <Label Grid.Column="1" Text="{Binding Character.Name}" Style="{StaticResource Headline}" FontSize="28" TextColor="{StaticResource WoWGold}"/>

                        <VerticalStackLayout Grid.Row="1" Grid.Column="1" Spacing="2">
                             <Label Text="{Binding Character.Class, StringFormat='Level {0} {1}'}" TextColor="{StaticResource WoWTextLight}" FontAttributes="Bold"/>
                             <Label Text="{Binding Character.Realm}" TextColor="{StaticResource Gray400}" FontSize="12"/>
                        </VerticalStackLayout>
                    </Grid>
                </Border>

                <!-- Mythic+ Score -->
                <Border Stroke="{StaticResource WoWBorder}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 8"
                        BackgroundColor="{StaticResource WoWPanelBackground}"
                        Padding="15">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Mythic+ Rating" Style="{StaticResource SubHeadline}" />
                        <Label Text="{Binding Summary.TotalScore, StringFormat='{0:F0}'}"
                               FontSize="40"
                               HorizontalOptions="Center"
                               TextColor="{StaticResource WoWGold}"
                               FontFamily="LifeCraft"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Best Runs -->
                <Label Text="Best Runs" Style="{StaticResource SubHeadline}" Margin="0,10,0,0" />
                <CollectionView ItemsSource="{Binding BestRuns}" HeightRequest="200">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="dto:RunDto">
                            <Border Stroke="{StaticResource WoWBorder}" StrokeThickness="1" BackgroundColor="{StaticResource WoWPanelBackground}" Padding="10" Margin="0,0,0,5">
                                <Grid ColumnDefinitions="*, Auto">
                                    <VerticalStackLayout Spacing="2">
                                        <Label Text="{Binding Dungeon}" TextColor="{StaticResource WoWTextLight}" FontAttributes="Bold" />
                                        <Label Text="{Binding Level, StringFormat='Level {0}'}" TextColor="{StaticResource WoWGoldDim}" FontSize="12" />
                                    </VerticalStackLayout>
                                    <Label Grid.Column="1" Text="{Binding Score, StringFormat='{0:F1}'}" TextColor="{StaticResource WoWTextLight}" VerticalOptions="Center" FontAttributes="Bold"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Recent Runs -->
                <Label Text="Recent Runs" Style="{StaticResource SubHeadline}" Margin="0,10,0,0" />
                <CollectionView ItemsSource="{Binding RecentRuns}" HeightRequest="200">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="dto:RunDto">
                            <Border Stroke="{StaticResource WoWBorder}" StrokeThickness="1" BackgroundColor="{StaticResource WoWPanelBackground}" Padding="10" Margin="0,0,0,5">
                                <Grid ColumnDefinitions="*, Auto">
                                    <VerticalStackLayout Spacing="2">
                                        <Label Text="{Binding Dungeon}" TextColor="{StaticResource WoWTextLight}" FontAttributes="Bold" />
                                        <Label Text="{Binding Level, StringFormat='Level {0}'}" TextColor="{StaticResource WoWGoldDim}" FontSize="12" />
                                    </VerticalStackLayout>
                                    <Label Grid.Column="1" Text="{Binding Score, StringFormat='{0:F1}'}" TextColor="{StaticResource WoWTextLight}" VerticalOptions="Center" FontAttributes="Bold"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>
